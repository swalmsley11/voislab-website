name: Production Deployment

on:
  workflow_dispatch:
    inputs:
      confirm_production:
        description: 'Type "CONFIRM" to deploy to production'
        required: true
        type: string
      deployment_reason:
        description: 'Reason for production deployment'
        required: true
        type: string

env:
  NODE_VERSION: '18'

jobs:
  validate-input:
    runs-on: ubuntu-latest
    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_production }}" != "CONFIRM" ]; then
            echo "Production deployment cancelled: confirmation not provided"
            exit 1
          fi
          echo "Production deployment confirmed"

      - name: Log deployment reason
        run: |
          echo "Deployment reason: ${{ github.event.inputs.deployment_reason }}"

  pre-deployment-checks:
    needs: validate-input
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install frontend dependencies
        run: npm ci

      - name: Run comprehensive tests
        run: |
          npm run lint
          npm run format:check
          npm run type-check
          npm run build

      - name: Install infrastructure dependencies
        working-directory: infrastructure
        run: npm ci

      - name: Run infrastructure tests
        working-directory: infrastructure
        run: npm test

      - name: Synthesize CDK
        working-directory: infrastructure
        run: npm run synth

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: dist/
          retention-days: 7

  deploy-production:
    needs: pre-deployment-checks
    runs-on: ubuntu-latest
    environment: 
      name: production
      url: ${{ steps.get-url.outputs.website_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: production-build
          path: dist/

      - name: Install infrastructure dependencies
        working-directory: infrastructure
        run: npm ci

      - name: Create deployment backup
        run: |
          BUCKET_NAME=$(aws cloudformation describe-stacks --stack-name VoislabWebsite-prod --query 'Stacks[0].Outputs[?OutputKey==`WebsiteBucketName`].OutputValue' --output text 2>/dev/null || echo "")
          if [ -n "$BUCKET_NAME" ]; then
            BACKUP_BUCKET="voislab-backup-$(date +%Y%m%d-%H%M%S)"
            echo "Creating backup of current production deployment"
            aws s3 sync s3://$BUCKET_NAME s3://$BACKUP_BUCKET/ || echo "No existing deployment to backup"
            echo "BACKUP_BUCKET=$BACKUP_BUCKET" >> $GITHUB_ENV
          fi

      - name: Deploy infrastructure to PROD
        working-directory: infrastructure
        run: npm run deploy:prod

      - name: Wait for stack deployment
        run: |
          aws cloudformation wait stack-update-complete --stack-name VoislabWebsite-prod || \
          aws cloudformation wait stack-create-complete --stack-name VoislabWebsite-prod

      - name: Deploy frontend to S3
        run: |
          BUCKET_NAME=$(aws cloudformation describe-stacks --stack-name VoislabWebsite-prod --query 'Stacks[0].Outputs[?OutputKey==`WebsiteBucketName`].OutputValue' --output text)
          if [ -z "$BUCKET_NAME" ]; then
            echo "Failed to get bucket name from CloudFormation stack"
            exit 1
          fi
          aws s3 sync dist/ s3://$BUCKET_NAME --delete

      - name: Invalidate CloudFront cache
        run: |
          DISTRIBUTION_ID=$(aws cloudformation describe-stacks --stack-name VoislabWebsite-prod --query 'Stacks[0].Outputs[?OutputKey==`DistributionId`].OutputValue' --output text)
          if [ -z "$DISTRIBUTION_ID" ]; then
            echo "Failed to get distribution ID from CloudFormation stack"
            exit 1
          fi
          INVALIDATION_ID=$(aws cloudfront create-invalidation --distribution-id $DISTRIBUTION_ID --paths "/*" --query 'Invalidation.Id' --output text)
          echo "CloudFront invalidation created: $INVALIDATION_ID"

      - name: Get website URL
        id: get-url
        run: |
          WEBSITE_URL=$(aws cloudformation describe-stacks --stack-name VoislabWebsite-prod --query 'Stacks[0].Outputs[?OutputKey==`WebsiteURL`].OutputValue' --output text)
          echo "website_url=$WEBSITE_URL" >> $GITHUB_OUTPUT
          echo "Production deployment successful: $WEBSITE_URL"

      - name: Post-deployment validation
        run: |
          WEBSITE_URL="${{ steps.get-url.outputs.website_url }}"
          if [ -n "$WEBSITE_URL" ]; then
            echo "Waiting for CloudFront propagation..."
            sleep 60
            
            # Health check with retries
            for i in {1..5}; do
              if curl -f -s "$WEBSITE_URL" > /dev/null; then
                echo "‚úÖ Website health check passed (attempt $i)"
                break
              else
                echo "‚ö†Ô∏è Website health check failed (attempt $i/5)"
                if [ $i -eq 5 ]; then
                  echo "‚ùå All health checks failed"
                  exit 1
                fi
                sleep 30
              fi
            done
            
            echo "‚úÖ Production deployment validation completed successfully"
          fi

      - name: Notify deployment success
        run: |
          echo "üöÄ Production deployment completed successfully!"
          echo "Website URL: ${{ steps.get-url.outputs.website_url }}"
          echo "Deployment reason: ${{ github.event.inputs.deployment_reason }}"
          echo "Deployed by: ${{ github.actor }}"
          echo "Commit: ${{ github.sha }}"

  post-deployment-cleanup:
    needs: deploy-production
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Clean up old backups
        run: |
          # Keep only the 5 most recent backups
          aws s3api list-buckets --query 'Buckets[?starts_with(Name, `voislab-backup-`)].Name' --output text | \
          sort -r | tail -n +6 | while read bucket; do
            if [ -n "$bucket" ]; then
              echo "Cleaning up old backup bucket: $bucket"
              aws s3 rb s3://$bucket --force || echo "Failed to delete $bucket"
            fi
          done