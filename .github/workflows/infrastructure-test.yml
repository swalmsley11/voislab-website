name: Infrastructure Testing

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'development'
        type: choice
        options:
        - development
        - production
      test_type:
        description: 'Type of test to run'
        required: true
        default: 'comprehensive'
        type: choice
        options:
        - comprehensive
        - security
        - performance
        - integration

env:
  NODE_VERSION: '18'

jobs:
  infrastructure-test:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: infrastructure/package-lock.json

      - name: Configure AWS credentials for DEV
        if: github.event.inputs.environment == 'development'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_DEV }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_DEV }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Configure AWS credentials for PROD
        if: github.event.inputs.environment == 'production'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Install dependencies
        working-directory: infrastructure
        run: npm ci

      - name: Run infrastructure unit tests
        working-directory: infrastructure
        run: npm test

      - name: Test stack synthesis
        working-directory: infrastructure
        run: |
          if [ "${{ github.event.inputs.environment }}" == "development" ]; then
            npm run synth -- --context environment=dev
          else
            npm run synth -- --context environment=prod
          fi

      - name: Comprehensive Infrastructure Tests
        if: github.event.inputs.test_type == 'comprehensive' || github.event.inputs.test_type == 'integration'
        run: |
          STACK_NAME="VoislabWebsite-${{ github.event.inputs.environment == 'development' && 'dev' || 'prod' }}"
          
          echo "=== Running Comprehensive Infrastructure Tests ==="
          
          # Test 1: Stack exists and is in good state
          echo "Testing stack existence and status..."
          STACK_STATUS=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query 'Stacks[0].StackStatus' --output text)
          echo "Stack status: $STACK_STATUS"
          
          if [[ "$STACK_STATUS" != "CREATE_COMPLETE" && "$STACK_STATUS" != "UPDATE_COMPLETE" ]]; then
            echo "❌ Stack is not in a healthy state: $STACK_STATUS"
            exit 1
          fi
          echo "✅ Stack is healthy"
          
          # Test 2: All required resources exist
          echo "Testing required resources..."
          REQUIRED_RESOURCES=("AWS::S3::Bucket" "AWS::DynamoDB::Table" "AWS::Lambda::Function" "AWS::CloudFront::Distribution")
          
          for resource_type in "${REQUIRED_RESOURCES[@]}"; do
            COUNT=$(aws cloudformation list-stack-resources --stack-name $STACK_NAME --query "StackResourceSummaries[?ResourceType=='$resource_type' && ResourceStatus!='DELETE_COMPLETE'] | length(@)")
            if [ "$COUNT" -eq 0 ]; then
              echo "❌ No resources of type $resource_type found"
              exit 1
            else
              echo "✅ Found $COUNT resources of type $resource_type"
            fi
          done
          
          # Test 3: Lambda functions are working
          echo "Testing Lambda functions..."
          AUDIO_PROCESSOR=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query "Stacks[0].Outputs[?OutputKey=='AudioProcessorFunctionName'].OutputValue" --output text)
          UAT_RUNNER=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query "Stacks[0].Outputs[?OutputKey=='UATRunnerFunctionName'].OutputValue" --output text)
          
          if [ -n "$AUDIO_PROCESSOR" ]; then
            aws lambda invoke --function-name $AUDIO_PROCESSOR --payload '{"test": true}' /tmp/response.json
            echo "✅ Audio processor function is invokable"
          fi
          
          if [ -n "$UAT_RUNNER" ]; then
            aws lambda invoke --function-name $UAT_RUNNER --payload '{"action": "health_check"}' /tmp/uat_response.json
            echo "✅ UAT runner function is invokable"
          fi
          
          # Test 4: S3 buckets are accessible and properly configured
          echo "Testing S3 buckets..."
          UPLOAD_BUCKET=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query "Stacks[0].Outputs[?OutputKey=='UploadBucketName'].OutputValue" --output text)
          MEDIA_BUCKET=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query "Stacks[0].Outputs[?OutputKey=='MediaBucketName'].OutputValue" --output text)
          
          for bucket in "$UPLOAD_BUCKET" "$MEDIA_BUCKET"; do
            if [ -n "$bucket" ]; then
              aws s3api head-bucket --bucket $bucket
              echo "✅ Bucket $bucket is accessible"
              
              # Check bucket policy
              aws s3api get-bucket-policy --bucket $bucket > /dev/null 2>&1 && echo "✅ Bucket $bucket has policy" || echo "ℹ️ Bucket $bucket has no policy"
            fi
          done
          
          # Test 5: DynamoDB table is accessible
          echo "Testing DynamoDB table..."
          METADATA_TABLE=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query "Stacks[0].Outputs[?OutputKey=='AudioMetadataTableName'].OutputValue" --output text)
          
          if [ -n "$METADATA_TABLE" ]; then
            aws dynamodb describe-table --table-name $METADATA_TABLE > /dev/null
            echo "✅ DynamoDB table $METADATA_TABLE is accessible"
          fi
          
          echo "✅ Comprehensive infrastructure tests completed successfully"

      - name: Security Tests
        if: github.event.inputs.test_type == 'comprehensive' || github.event.inputs.test_type == 'security'
        run: |
          STACK_NAME="VoislabWebsite-${{ github.event.inputs.environment == 'development' && 'dev' || 'prod' }}"
          
          echo "=== Running Security Tests ==="
          
          # Test S3 bucket security
          echo "Testing S3 bucket security..."
          UPLOAD_BUCKET=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query "Stacks[0].Outputs[?OutputKey=='UploadBucketName'].OutputValue" --output text)
          MEDIA_BUCKET=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query "Stacks[0].Outputs[?OutputKey=='MediaBucketName'].OutputValue" --output text)
          
          for bucket in "$UPLOAD_BUCKET" "$MEDIA_BUCKET"; do
            if [ -n "$bucket" ]; then
              # Check public access block
              PUBLIC_ACCESS=$(aws s3api get-public-access-block --bucket $bucket --query 'PublicAccessBlockConfiguration.BlockPublicAcls' --output text)
              if [ "$PUBLIC_ACCESS" = "True" ]; then
                echo "✅ Bucket $bucket has public access blocked"
              else
                echo "❌ Bucket $bucket allows public access"
                exit 1
              fi
              
              # Check encryption
              aws s3api get-bucket-encryption --bucket $bucket > /dev/null 2>&1 && echo "✅ Bucket $bucket is encrypted" || echo "⚠️ Bucket $bucket encryption not configured"
            fi
          done
          
          # Test Lambda function permissions
          echo "Testing Lambda function security..."
          AUDIO_PROCESSOR=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query "Stacks[0].Outputs[?OutputKey=='AudioProcessorFunctionName'].OutputValue" --output text)
          
          if [ -n "$AUDIO_PROCESSOR" ]; then
            # Check if function has appropriate IAM role
            ROLE_ARN=$(aws lambda get-function --function-name $AUDIO_PROCESSOR --query 'Configuration.Role' --output text)
            echo "✅ Audio processor has IAM role: $ROLE_ARN"
          fi
          
          echo "✅ Security tests completed"

      - name: Performance Tests
        if: github.event.inputs.test_type == 'comprehensive' || github.event.inputs.test_type == 'performance'
        run: |
          STACK_NAME="VoislabWebsite-${{ github.event.inputs.environment == 'development' && 'dev' || 'prod' }}"
          
          echo "=== Running Performance Tests ==="
          
          # Test Lambda cold start times
          echo "Testing Lambda performance..."
          AUDIO_PROCESSOR=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query "Stacks[0].Outputs[?OutputKey=='AudioProcessorFunctionName'].OutputValue" --output text)
          
          if [ -n "$AUDIO_PROCESSOR" ]; then
            echo "Testing cold start performance..."
            START_TIME=$(date +%s%N)
            aws lambda invoke --function-name $AUDIO_PROCESSOR --payload '{"test": true}' /tmp/perf_response.json > /dev/null
            END_TIME=$(date +%s%N)
            DURATION=$(( (END_TIME - START_TIME) / 1000000 ))
            echo "✅ Lambda cold start: ${DURATION}ms"
            
            if [ $DURATION -gt 10000 ]; then
              echo "⚠️ Lambda cold start is slow (>10s)"
            fi
          fi
          
          # Test CloudFront response times
          echo "Testing CloudFront performance..."
          MEDIA_DISTRIBUTION=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query "Stacks[0].Outputs[?OutputKey=='MediaDistributionDomainName'].OutputValue" --output text)
          
          if [ -n "$MEDIA_DISTRIBUTION" ]; then
            START_TIME=$(date +%s%N)
            curl -s -o /dev/null -w "%{http_code}" "https://$MEDIA_DISTRIBUTION" > /tmp/cf_response.txt
            END_TIME=$(date +%s%N)
            DURATION=$(( (END_TIME - START_TIME) / 1000000 ))
            HTTP_CODE=$(cat /tmp/cf_response.txt)
            
            echo "✅ CloudFront response: ${DURATION}ms (HTTP $HTTP_CODE)"
            
            if [ $DURATION -gt 5000 ]; then
              echo "⚠️ CloudFront response is slow (>5s)"
            fi
          fi
          
          echo "✅ Performance tests completed"

      - name: Generate test report
        if: always()
        run: |
          echo "=== Infrastructure Test Report ==="
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Test Type: ${{ github.event.inputs.test_type }}"
          echo "Timestamp: $(date -u)"
          echo "Region: ${{ secrets.AWS_REGION }}"
          echo ""
          
          STACK_NAME="VoislabWebsite-${{ github.event.inputs.environment == 'development' && 'dev' || 'prod' }}"
          
          if aws cloudformation describe-stacks --stack-name $STACK_NAME &>/dev/null; then
            echo "Stack Status: $(aws cloudformation describe-stacks --stack-name $STACK_NAME --query 'Stacks[0].StackStatus' --output text)"
            echo "Last Updated: $(aws cloudformation describe-stacks --stack-name $STACK_NAME --query 'Stacks[0].LastUpdatedTime' --output text)"
            echo ""
            echo "Key Resources:"
            aws cloudformation describe-stacks --stack-name $STACK_NAME --query 'Stacks[0].Outputs[?OutputKey==`UploadBucketName` || OutputKey==`MediaBucketName` || OutputKey==`AudioMetadataTableName`].[OutputKey,OutputValue]' --output table
          else
            echo "❌ Stack not found: $STACK_NAME"
          fi